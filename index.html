<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitQuest - Your Ultimate Fitness Guide</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for vibrant background and layout */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            color: #ffffff;
            
            /* --- NEW: Full-screen background image for Home View --- */
            background-image: url('https://placehold.co/1920x1080/1f2937/ffffff?text=FITNESS+MOMENTUM+START+NOW');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            /* -------------------------------------------------------- */
        }
        
        /* NEW: Dark overlay for all views *except* the home screen, ensuring text legibility over the background image */
        .content-overlay {
            background: rgba(31, 41, 55, 0.95); /* Dark semi-transparent background */
            min-height: 100vh;
        }

        .muscle-svg path:hover {
            fill: #facc15; /* Yellow on hover */
            cursor: pointer;
        }
        /* Style for the interactive navigation bar options */
        .nav-option {
            transition: all 0.3s ease;
            cursor: pointer;
            border-bottom: 4px solid transparent;
        }
        .nav-option:hover {
            background-color: #374151;
            border-bottom-color: #4f46e5; /* Indigo accent */
        }
        .nav-option.active {
            background-color: #4f46e5;
            border-bottom-color: #facc15; /* Yellow active accent */
        }
        .scroll-y {
            overflow-y: auto;
            max-height: calc(100vh - 200px); /* Adjust max height for content scrolling */
        }
        
        /* Custom Animation for the new button's outer layer */
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.05); }
        }
        .animate-pulse-slow {
            animation: pulse-slow 3s infinite ease-in-out;
        }
    </style>
</head>
<body>

    <div id="app">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <script type="module">
        // --- 1. State Management and Core Variables ---
        let currentView = 'home';
        let quizTimer = null;
        const totalQuizTime = 20 * 60; // 20 minutes in seconds
        let timeLeft = totalQuizTime;
        const appElement = document.getElementById('app');

        // Authentication State (Mock)
        let isLoggedIn = false;
        let username = '';
        
        // --- Gemini API State ---
        let isGeneratingRecipe = false;
        let recipeQuery = '';
        let recipeResult = { text: '', sources: [] }; // Stores the generated recipe and its sources


        // --- 2. Data Definitions (Muscles, Quiz, Nutrition) ---

        // Option 1: Mock Muscle Data (50 entries for detail)
        const muscleAtlasData = [
            { name: "Deltoid", group: "Shoulder", detail: "The primary muscle responsible for lifting the arm. It has anterior, medial, and posterior heads." },
            { name: "Biceps Brachii", group: "Arm", detail: "Known for flexing the elbow and supinating the forearm. It has two heads." },
            { name: "Triceps Brachii", group: "Arm", detail: "The primary muscle for extending the elbow. It has three heads: long, lateral, and medial." },
            { name: "Pectoralis Major", group: "Chest", detail: "Large fan-shaped muscle on the chest, responsible for arm movements like flexion and adduction." },
            { name: "Latissimus Dorsi", group: "Back", detail: "The largest muscle in the upper body, responsible for extension, adduction, and internal rotation of the shoulder joint." },
            { name: "Rectus Abdominis", group: "Core", detail: "The 'six-pack' muscle. Responsible for spinal flexion (crunches)." },
            { name: "Quadriceps Femoris", group: "Leg", detail: "Group of four muscles on the front of the thigh, critical for knee extension." },
            { name: "Hamstrings", group: "Leg", detail: "Group of three muscles on the back of the thigh, primarily responsible for knee flexion and hip extension." },
            { name: "Gluteus Maximus", group: "Glutes", detail: "Largest and most powerful muscle in the human body, responsible for hip extension." },
            { name: "Gastrocnemius", group: "Calf", detail: "The main visible muscle of the calf, important for standing and walking (plantar flexion)." },
            // Add 40 more entries for the "50 muscles in detail" requirement
            { name: "Trapezius (Upper)", group: "Back/Neck", detail: "Shrugs the shoulders up towards the ears." },
            { name: "Obliques", group: "Core", detail: "Located on the sides, responsible for twisting and lateral flexion of the trunk." },
            { name: "Rhomboids", group: "Back", detail: "Pulls the shoulder blades together (retraction)." },
            { name: "Tibialis Anterior", group: "Leg", detail: "Muscle on the front of the shin, responsible for lifting the foot (dorsiflexion)." },
            ...Array(36).fill(0).map((_, i) => ({ name: `Muscle ${i + 15}`, group: "Misc", detail: "Detailed description goes here for muscle #"+(i+15) })),
        ];

        // Option 4: Quiz Data (5 questions to demonstrate the feature; needs to be expanded to 30)
        const quizData = [
            {
                question: "Which muscle group is responsible for extending the knee?",
                options: ["Hamstrings", "Quadriceps", "Calves", "Glutes"],
                answer: "Quadriceps"
            },
            {
                question: "What type of nutrient is the body's primary source of energy?",
                options: ["Protein", "Fats", "Carbohydrates", "Vitamins"],
                answer: "Carbohydrates"
            },
            {
                question: "Which exercise primarily targets the Latissimus Dorsi?",
                options: ["Bench Press", "Overhead Press", "Barbell Row", "Leg Extension"],
                answer: "Barbell Row"
            },
            {
                question: "How many heads does the Triceps Brachii muscle have?",
                options: ["One", "Two", "Three", "Four"],
                answer: "Three"
            },
            {
                question: "Which vitamin is crucial for calcium absorption?",
                options: ["Vitamin C", "Vitamin D", "Vitamin A", "Biotin"],
                answer: "Vitamin D"
            }
            // Add 25 more questions here to meet the "30 question" requirement.
        ];


        // --- 3. View Switching Logic and Helpers ---

        function navigateTo(view) {
            currentView = view;
            renderApp();
            if (view !== 'quiz' && quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
        }
        
        /**
         * Function to handle user logout. Resets authentication state and navigates home.
         */
        function handleLogout() {
            isLoggedIn = false;
            username = '';
            // Immediately navigate to the home view after logging out
            navigateTo('home');
        }


        // Utility for creating the Back Button (to Menu or Profile)
        function getBackButton(targetView = 'menu') {
            const backText = targetView === 'menu' ? 'Menu' : 'Profile';
            return `
                <button onclick="navigateTo('${targetView}')" class="mt-6 px-4 py-2 bg-pink-500 text-white font-bold rounded-lg shadow-md hover:bg-pink-600 transition duration-150">
                    ‚Üê Back to ${backText}
                </button>
            `;
        }
        
        // Helper to generate image placeholder URLs
        const placeholderImageUrl = (w, h, text, bgColor = '4f46e5', textColor = 'ffffff') => 
            `https://placehold.co/${w}x${h}/${bgColor}/${textColor}?text=${text}`;


        // --- 4. Renderer Functions: Main Structure ---

        function renderApp() {
            appElement.innerHTML = '';
            
            if (currentView === 'home') {
                // Home screen uses the body background
                appElement.innerHTML = renderHome();
            } else {
                // Global Header with Login/Profile Button
                let headerButton = `<button onclick="navigateTo('${isLoggedIn ? 'profile' : 'login'}')" 
                            class="px-4 py-2 bg-indigo-500 text-white font-bold rounded-lg shadow-xl hover:bg-indigo-600 transition text-sm md:text-base">
                        ${isLoggedIn ? `Profile (${username.substring(0, 1).toUpperCase()})` : 'Login / Sign Up'}
                    </button>`;

                // If on Login or Profile screens, don't show the button here (it will use the back button or logout button)
                if (currentView === 'login' || currentView.startsWith('profile')) {
                    headerButton = '';
                }

                const globalHeader = `
                    <div class="flex justify-between items-center p-2 md:p-4 sticky top-0 z-20">
                        <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-indigo-400">FitQuest</h1>
                        ${headerButton}
                    </div>
                `;
                
                // Content for all other pages is wrapped in a dark overlay
                appElement.innerHTML = globalHeader + renderNavBar() + '<div class="content-overlay p-4 md:p-8 pt-0">' + renderCurrentView() + '</div>';
            }
        }

        // Home View (UPDATED: Removed embedded image, relies on full-screen background)
        function renderHome() {
            return `
                <div class="flex flex-col items-center justify-center min-h-screen text-center p-4">
                    <div class="p-8 md:p-12 bg-white bg-opacity-10 rounded-3xl shadow-2xl backdrop-blur-sm transform hover:scale-[1.01] transition duration-500 ease-in-out border-4 border-indigo-400 max-w-lg w-full">
                        
                        <!-- Removed small fitness image here, as the body now has a full-screen background image -->

                        <h1 class="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-pink-500 mb-2">
                            FitQuest
                        </h1>
                        <p class="text-xl text-gray-200 mb-10 font-light italic">
                            Your Daily Blueprint for Strength & Nutrition.
                        </p>
                        
                        <!-- Double Shape CTA Button -->
                        <button onclick="navigateTo('muscles')" 
                                class="relative z-10 p-1.5 rounded-2xl bg-indigo-600 hover:bg-indigo-700 transition duration-300 shadow-xl group">
                            <!-- Outer/First shape: Pulsing Border -->
                            <span class="absolute inset-0 rounded-2xl border-4 border-pink-400 group-hover:border-pink-300 transition duration-300 animate-pulse-slow"></span>
                            <!-- Inner/Second shape: Text Holder -->
                            <span class="relative z-20 block px-12 py-4 bg-pink-500 text-white font-black text-xl rounded-xl transform group-hover:scale-105 transition duration-300">
                                START YOUR QUEST
                            </span>
                        </button>

                    </div>
                </div>
            `;
        }

        // Navigation Bar (Menu Options)
        function renderNavBar() {
            const options = [
                { id: 'muscles', name: 'Muscle Atlas', icon: 'üí™' },
                { id: 'body_map', name: 'Body Workout Map', icon: 'üë§' },
                { id: 'nutrition', name: 'Nutrition Guide', icon: 'üçé' },
                { id: 'quiz', name: 'Fitness Quiz Challenge', icon: '‚è±Ô∏è' },
                { id: 'community', name: 'Community Hub', icon: 'üí¨' },
                { id: 'about', name: 'About FitQuest', icon: '‚ÑπÔ∏è' },
            ];

            // Only show the menu on the main content views
            if (['login', 'profile', 'steps', 'calories', 'workout', 'streak', 'friends_leaderboard'].includes(currentView)) {
                return ''; // Hide the bar on specific profile/login views
            }

            const navItems = options.map(option => `
                <div class="nav-option ${currentView === option.id ? 'active' : ''} flex-1 text-center py-3 px-1 md:px-4 text-sm md:text-base font-semibold border-b-2 border-transparent transition duration-200 ease-in-out"
                     onclick="navigateTo('${option.id}')">
                    ${option.icon} <span class="hidden md:inline">${option.name}</span>
                </div>
            `).join('');

            // Note: Updated the sticky positioning to top-0 for better alignment within the new content-overlay structure
            return `
                <nav class="sticky top-0 z-10 bg-gray-800 bg-opacity-90 backdrop-blur-md shadow-xl rounded-b-xl mb-6">
                    <div class="flex justify-between items-center text-white">
                        <div class="flex flex-1 overflow-x-auto whitespace-nowrap">
                            ${navItems}
                        </div>
                    </div>
                </nav>
            `;
        }
        
        // Dynamic View Router
        function renderCurrentView() {
            switch (currentView) {
                // NEW VIEWS
                case 'login': return renderLogin();
                case 'profile': return renderProfile();
                case 'steps': return renderProfileSubView('Steps/Walking Tracker', renderSteps());
                case 'calories': return renderProfileSubView('Calories & Food Log', renderCalories());
                case 'workout': return renderProfileSubView('Workout and Exercise Log', renderWorkout());
                case 'streak': return renderProfileSubView('Daily Streak & Achievements', renderStreak());
                case 'friends_leaderboard': return renderProfileSubView('Friends Leaderboard', renderFriendsLeaderboard());
                
                // EXISTING VIEWS
                case 'muscles': return renderMuscles();
                case 'body_map': return renderBodyMap();
                case 'nutrition': return renderNutrition();
                case 'quiz': return renderQuiz();
                case 'community': return renderCommunity();
                case 'about': return renderAbout();
                default: return renderMuscles(); // Default to first menu item
            }
        }
        
        // --- 5. New Renderer Functions (Login & Profile) ---
        
        function handleLogin(event) {
            event.preventDefault();
            const form = event.target;
            const input = form.querySelector('#login-name');
            const name = input.value.trim();
            
            if (name) {
                isLoggedIn = true;
                username = name;
                navigateTo('profile');
            }
        }
        
        function renderLogin() {
            // Attach the submit listener after the form is rendered
            setTimeout(() => {
                const form = document.getElementById('login-form');
                if (form) form.addEventListener('submit', handleLogin);
            }, 0);

            return `
                <div class="max-w-md mx-auto mt-16 p-8 bg-white bg-opacity-10 rounded-2xl shadow-2xl backdrop-blur-sm border border-indigo-500">
                    <h2 class="text-4xl font-black text-pink-400 mb-6 text-center">Member Login</h2>
                    <p class="text-gray-300 mb-6 text-center">Enter your name to access your FitQuest Profile!</p>
                    
                    <form id="login-form" class="space-y-4">
                        <input type="text" id="login-name" placeholder="Your Name or Nickname" required
                               class="w-full p-4 border-2 border-indigo-300 rounded-xl text-gray-900 focus:ring-pink-500 focus:border-pink-500 text-lg">
                        
                        <button type="submit" class="w-full p-4 bg-pink-500 text-white font-bold text-xl rounded-xl shadow-lg hover:bg-pink-600 transition duration-200 transform hover:scale-[1.01]">
                            LOGIN / CREATE PROFILE
                        </button>
                    </form>
                    ${getBackButton('menu')}
                </div>
            `;
        }

        function renderProfile() {
            if (!isLoggedIn) {
                return renderLogin(); // Redirect if somehow not logged in
            }

            const profileOptions = [
                { id: 'steps', name: 'Steps/Walking Tracker', icon: 'üëü' },
                { id: 'calories', name: 'Calories and Food Log', icon: 'üçï' },
                { id: 'workout', name: 'Workout and Exercise Log', icon: 'üèãÔ∏è' },
                { id: 'streak', name: 'Daily Streak & Achievements', icon: 'üî•' },
                { id: 'friends_leaderboard', name: 'Friends Leaderboard', icon: 'üèÜ' },
            ];

            const optionCards = profileOptions.map(option => `
                <div onclick="navigateTo('${option.id}')" 
                     class="bg-gray-700 p-6 rounded-xl shadow-2xl cursor-pointer hover:bg-indigo-600 transition duration-200 transform hover:scale-[1.03] border-t-4 border-pink-500">
                    <div class="text-5xl mb-3">${option.icon}</div>
                    <h3 class="text-xl font-bold text-white">${option.name}</h3>
                    <p class="text-sm text-gray-300 mt-1">View your daily progress and status.</p>
                </div>
            `).join('');

            return `
                <div class="max-w-5xl mx-auto">
                    <h2 class="text-4xl font-extrabold text-indigo-400 mb-4">üëë ${username}'s Profile Dashboard</h2>
                    <p class="text-xl text-gray-300 mb-8">Welcome back! View your personal fitness status below.</p>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                        ${optionCards}
                    </div>
                    
                    <!-- LOGOUT BUTTON -->
                    <button onclick="handleLogout()" class="mt-10 w-full md:w-auto px-6 py-3 bg-red-600 text-white font-bold rounded-lg shadow-xl hover:bg-red-700 transition duration-150 transform hover:scale-[1.01] text-lg">
                        Log Out üëã
                    </button>
                </div>
            `;
        }

        function renderProfileSubView(title, content) {
            return `
                <div class="max-w-4xl mx-auto p-6 bg-gray-800 rounded-xl shadow-2xl">
                    <h3 class="text-3xl font-bold text-pink-400 border-b-2 border-gray-700 pb-3 mb-6">${title}</h3>
                    ${content}
                    ${getBackButton('profile')}
                </div>
            `;
        }

        // --- Profile Sub-View Content Functions (New Requirements) ---
        
        function renderSteps() {
            return `
                <div class="space-y-4 text-gray-300">
                    <p class="text-xl font-semibold">Today's Progress:</p>
                    <div class="flex items-center space-x-4 p-4 bg-gray-700 rounded-lg">
                        <span class="text-4xl text-indigo-400">üö∂</span>
                        <div>
                            <p class="text-2xl font-bold text-white">12,450 Steps</p>
                            <p>Goal: 10,000 Steps (Goal Achieved!)</p>
                        </div>
                    </div>
                    <p class="pt-4">Track your walking distance and steps to improve cardiovascular health and boost metabolism.</p>
                </div>
            `;
        }

        function renderCalories() {
            return `
                <div class="space-y-4 text-gray-300">
                    <p class="text-xl font-semibold">Calorie Summary:</p>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="p-4 bg-green-700 bg-opacity-30 rounded-lg">
                            <p class="text-3xl font-bold">1800</p>
                            <p>Consumed</p>
                        </div>
                        <div class="p-4 bg-red-700 bg-opacity-30 rounded-lg">
                            <p class="text-3xl font-bold">500</p>
                            <p>Burned</p>
                        </div>
                        <div class="p-4 bg-indigo-700 bg-opacity-30 rounded-lg">
                            <p class="text-3xl font-bold">1300</p>
                            <p>Net Calories</p>
                        </div>
                    </div>
                    <p class="pt-4">Log your meals and track your caloric intake to manage weight effectively. Remember to hit your protein goals!</p>
                </div>
            `;
        }
        
        function renderWorkout() {
            return `
                <div class="space-y-4 text-gray-300">
                    <p class="text-xl font-semibold">Last Session:</p>
                    <ul class="space-y-3 p-4 bg-gray-700 rounded-lg">
                        <li class="border-b border-gray-600 pb-2">**Squats:** 3 sets of 10 reps @ 135 lbs</li>
                        <li class="border-b border-gray-600 pb-2">**Bench Press:** 3 sets of 8 reps @ 95 lbs</li>
                        <li>**Barbell Row:** 4 sets of 12 reps @ 80 lbs</li>
                    </ul>
                    <p class="pt-4">Keep a detailed record of your lifts and endurance training. Consistency is the secret to strength gain!</p>
                </div>
            `;
        }

        function renderStreak() {
            return `
                <div class="space-y-6 text-gray-300 text-center">
                    <p class="text-xl font-semibold text-pink-300">Current Daily Consistency Streak:</p>
                    <div class="p-8 bg-yellow-800 bg-opacity-50 rounded-full w-48 h-48 mx-auto flex items-center justify-center shadow-2xl border-4 border-yellow-400">
                        <p class="text-6xl font-black text-yellow-100">45</p>
                    </div>
                    <p class="text-2xl font-bold mt-4">Days in a Row!</p>
                    
                    <div class="mt-8">
                        <h4 class="text-lg font-bold text-indigo-300 mb-3">Recent Achievements:</h4>
                        <div class="flex justify-center space-x-4">
                            <span class="p-3 bg-indigo-600 rounded-lg text-sm shadow-md">ü•á First 5K Badge</span>
                            <span class="p-3 bg-indigo-600 rounded-lg text-sm shadow-md">üí™ 100K Steps Challenge</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderFriendsLeaderboard() {
            const mockFriends = [
                { name: "Anugrah ", score: 5500, rank: 1 },
                { name: username, score: 5120, rank: 'You' },
                { name: "Shivang S", score: 4890, rank: 3 },
                { name: "Aiman P", score: 4500, rank: 4 },
                { name: "Binshad", score: 4000, rank: 5 },
            ];

            const list = mockFriends.map((friend, index) => `
                <div class="flex justify-between items-center p-3 rounded-lg ${friend.rank === 'You' ? 'bg-indigo-700 border-l-4 border-pink-400' : 'bg-gray-700'} hover:bg-gray-600 transition">
                    <span class="font-bold w-10 text-center text-pink-300">${friend.rank !== 'You' ? `#${friend.rank}` : 'YOU'}</span>
                    <span class="flex-grow font-medium text-white">${friend.name}</span>
                    <span class="text-xl font-extrabold text-yellow-300">${friend.score} Pts</span>
                </div>
            `).join('');

            return `
                <div class="space-y-4 text-gray-300">
                    <p class="text-xl font-semibold">Your Friends' Progress (Total Points):</p>
                    <div class="space-y-2">
                        ${list}
                    </div>
                    <p class="pt-4 text-sm italic">Challenge your friends to see who can earn the most fitness points each week!</p>
                </div>
            `;
        }

        // --- 6. Existing Renderer Functions (Moved from original code) ---
        
        function renderMuscles() {
            const listItems = muscleAtlasData.map(m => `
                <details class="group bg-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-600 transition duration-150 shadow-lg">
                    <summary class="flex justify-between items-center font-bold text-lg text-indigo-300">
                        ${m.name} (${m.group})
                        <span class="text-indigo-400 group-open:rotate-90 transition transform">‚ñ∂</span>
                    </summary>
                    <p class="mt-2 text-gray-300 border-t border-gray-600 pt-2">${m.detail}</p>
                </details>
            `).join('');

            return `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-extrabold text-indigo-400 mb-6">üí™ Muscle Atlas (50 Key Muscles)</h2>
                    <p class="text-gray-300 mb-6">Tap any muscle to view detailed function and location.</p>
                    <div class="space-y-3 scroll-y">
                        ${listItems}
                    </div>
                    ${getBackButton()}
                </div>
            `;
        }

        function renderBodyMap() {
            // Function definition for showWorkout is placed inside the script tag for global access
            setTimeout(() => {
                window.showWorkout = (part) => {
                    let workout = "";
                    switch(part) {
                        case 'Core': workout = "Suggested Workouts: Planks, Crunches, Russian Twists, Leg Raises."; break;
                        case 'Arms': workout = "Suggested Workouts: Bicep Curls, Tricep Extensions, Push-ups, Dips."; break;
                        case 'Legs/Glutes': workout = "Suggested Workouts: Squats, Lunges, Deadlifts, Calf Raises, Glute Bridges."; break;
                        case 'Neck/Shoulders': workout = "Suggested Workouts: Shoulder Press, Lateral Raises, Shrugs."; break;
                        default: workout = "No specific workout found for this part.";
                    }
                    const detailsElement = document.getElementById('workout-details');
                    if (detailsElement) {
                         detailsElement.innerHTML = `
                            <h3 class="font-bold text-indigo-600 text-xl mb-2">${part} Workout</h3>
                            <p>${workout}</p>
                        `;
                    }
                }
            }, 0);

            return `
                <div class="max-w-4xl mx-auto text-center">
                    <h2 class="text-3xl font-extrabold text-indigo-400 mb-6">üë§ Body Workout Map</h2>
                    <p class="text-gray-300 mb-6">Click on a body part to see suggested exercises!</p>
                    
                    <div class="bg-white p-6 rounded-xl shadow-2xl relative w-full max-w-sm mx-auto">
                        <!-- Simple SVG representation of a human body -->
                        <svg viewBox="0 0 200 400" xmlns="http://www.w3.org/2000/svg" class="muscle-svg w-full h-auto">
                            <!-- Torso/Core -->
                            <rect id="core" x="70" y="50" width="60" height="100" fill="#4f46e5" rx="10" onclick="showWorkout('Core')"/>
                            <!-- Head -->
                            <circle id="head" cx="100" cy="30" r="25" fill="#facc15" onclick="showWorkout('Neck/Shoulders')"/>
                            <!-- Arms -->
                            <rect id="arm_left" x="40" y="50" width="30" height="80" fill="#facc15" rx="10" onclick="showWorkout('Arms')"/>
                            <rect id="arm_right" x="130" y="50" width="30" height="80" fill="#facc15" rx="10" onclick="showWorkout('Arms')"/>
                            <!-- Legs -->
                            <rect id="leg_left" x="70" y="150" width="30" height="180" fill="#facc15" rx="10" onclick="showWorkout('Legs/Glutes')"/>
                            <rect id="leg_right" x="100" y="150" width="30" height="180" fill="#facc15" rx="10" onclick="showWorkout('Legs/Glutes')"/>
                        </svg>
                        
                        <!-- Workout Details Display -->
                        <div id="workout-details" class="mt-6 p-4 bg-gray-100 text-gray-800 rounded-lg text-left shadow-inner border-t-2 border-indigo-500">
                            Select a body part on the figure above to see workout suggestions.
                        </div>
                    </div>
                    
                    ${getBackButton()}
                </div>
            `;
        }
        
        function renderNutrition() {
            // Attach input change listener
            setTimeout(() => {
                const input = document.getElementById('recipe-query-input');
                if (input) {
                    input.value = recipeQuery; // Restore previous query
                    input.addEventListener('input', (e) => {
                        recipeQuery = e.target.value;
                    });
                }
            }, 0);

            // Function to render the generated recipe results
            const renderRecipeResult = () => {
                if (isGeneratingRecipe) {
                    return `
                        <div class="flex items-center justify-center p-8 bg-gray-700 rounded-xl">
                            <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-pink-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-pink-400 font-semibold">Generating your custom recipe...</span>
                        </div>
                    `;
                }
                
                if (recipeResult.text) {
                    let sourceHtml = '';
                    if (recipeResult.sources.length > 0) {
                        sourceHtml = `
                            <h4 class="text-lg font-bold text-yellow-300 mt-4 border-t border-gray-700 pt-3">Sources:</h4>
                            <ul class="list-disc list-inside text-sm text-gray-400 mt-2">
                                ${recipeResult.sources.map(s => 
                                    `<li><a href="${s.uri}" target="_blank" class="hover:text-yellow-400 break-words">${s.title}</a></li>`
                                ).join('')}
                            </ul>
                        `;
                    }

                    return `
                        <div class="bg-indigo-900 bg-opacity-30 p-6 rounded-xl shadow-2xl border-l-4 border-indigo-400 whitespace-pre-wrap">
                            <h3 class="text-2xl font-bold text-pink-400 mb-3">Generated Recipe:</h3>
                            <p class="text-gray-200">${recipeResult.text}</p>
                            ${sourceHtml}
                        </div>
                    `;
                }

                return `<div class="p-4 text-center text-gray-500 italic">No recipe generated yet. Enter a query above!</div>`;
            };


            return `
                <div class="max-w-5xl mx-auto">
                    <h2 class="text-3xl font-extrabold text-indigo-400 mb-6">üçé Nutrition & Protein Guide</h2>
                    <p class="text-gray-300 mb-8">Essential nutrients, protein sources, and a powerful **Recipe Generator** below!</p>

                    <!-- --- NEW: GEMINI RECIPE GENERATOR FEATURE --- -->
                    <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl border-4 border-pink-500 mb-8">
                        <h3 class="text-2xl font-black text-pink-300 mb-4 flex items-center">
                            ‚ú® Custom Recipe Generator (AI Powered)
                        </h3>
                        <p class="text-gray-400 mb-4">
                            Tell us what you have, or what your goals are (e.g., "high protein dinner with chicken and rice" or "vegan quick-lunch").
                        </p>
                        
                        <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3 mb-6">
                            <input type="text" id="recipe-query-input" placeholder="Your ingredients, diet, or goal..."
                                   class="flex-grow p-3 rounded-lg bg-gray-700 text-white border-2 border-pink-500 focus:ring-pink-400 focus:border-pink-400" 
                                   value="${recipeQuery || ''}" 
                                   onchange="window.recipeQuery = this.value;">
                            <button onclick="generateRecipe()" 
                                    class="w-full md:w-auto p-3 bg-indigo-500 text-white font-bold rounded-lg hover:bg-indigo-600 transition duration-150 transform hover:scale-[1.01] disabled:opacity-50"
                                    ${isGeneratingRecipe ? 'disabled' : ''}>
                                ${isGeneratingRecipe ? 'Generating...' : '‚ú® Generate Recipe'}
                            </button>
                        </div>
                        
                        <!-- Recipe Result Area -->
                        ${renderRecipeResult()}
                    </div>
                    <!-- --- END GEMINI FEATURE --- -->

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Vegetarian Section -->
                        <div class="bg-green-700 bg-opacity-30 p-6 rounded-xl shadow-xl border-t-4 border-green-400">
                            <h3 class="text-2xl font-bold text-green-300 mb-4">Vegetarian & Vegan Protein</h3>
                            
                            <img src="${placeholderImageUrl(400, 200, 'VEG+PROTEIN', '10b981', 'ffffff')}" 
                                 alt="Vegetarian protein sources" class="w-full h-48 object-cover rounded-lg mb-4 shadow-md">
                            
                            <ul class="space-y-3 text-gray-200 list-disc list-inside">
                                <li>**Lentils & Beans:** High in fiber and iron. Excellent muscle building base.</li>
                                <li>**Tofu & Tempeh:** Versatile soy-based proteins. Tofu is softer; Tempeh is fermented and nutty.</li>
                                <li>**Quinoa:** A complete protein source, containing all nine essential amino acids.</li>
                                <li>**Nuts & Seeds:** Almonds, chia seeds, and flax seeds provide healthy fats and protein.</li>
                                <li>**Dairy/Eggs (Lacto-Ovo):** Milk, yogurt, and eggs are complete proteins for non-vegans.</li>
                            </ul>
                        </div>

                        <!-- Non-Vegetarian Section -->
                        <div class="bg-red-700 bg-opacity-30 p-6 rounded-xl shadow-xl border-t-4 border-red-400">
                            <h3 class="text-2xl font-bold text-red-300 mb-4">Non-Vegetarian Protein</h3>
                            
                            <img src="${placeholderImageUrl(400, 200, 'NON-VEG+PROTEIN', 'dc2626', 'ffffff')}" 
                                 alt="Non-Vegetarian protein sources" class="w-full h-48 object-cover rounded-lg mb-4 shadow-md">
                            
                            <ul class="space-y-3 text-gray-200 list-disc list-inside">
                                <li>**Chicken Breast:** Lean source of complete protein, low in fat.</li>
                                <li>**Fish (Salmon/Tuna):** Provides protein along with essential Omega-3 fatty acids.</li>
                                <li>**Red Meat (Beef/Lamb):** High in protein, iron, and B vitamins (consume in moderation).</li>
                                <li>**Whey/Casein Protein:** Highly bioavailable protein powders derived from milk.</li>
                                <li>**Eggs:** One of the most complete and affordable sources of protein and micronutrients.</li>
                            </ul>
                        </div>
                    </div>
                    ${getBackButton()}
                </div>
            `;
        }
        
        function renderQuiz() {
            // Start the timer when the quiz view loads
            if (!quizTimer) {
                timeLeft = totalQuizTime; // Reset timer
                startQuizTimer();
            }

            // Attach submit listener *after* the form is rendered
            setTimeout(() => {
                const form = document.getElementById('quiz-form');
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        submitQuiz(e);
                    });
                }
            }, 0);


            return `
                <div class="max-w-xl mx-auto">
                    <h2 class="text-3xl font-extrabold text-indigo-400 mb-4">‚è±Ô∏è Fitness Quiz Challenge</h2>
                    <div class="flex justify-between items-center mb-6 p-4 bg-yellow-500 text-gray-900 rounded-lg shadow-xl">
                        <span class="font-bold text-lg">Time Remaining:</span>
                        <span id="quiz-timer" class="text-2xl font-extrabold">20:00</span>
                    </div>
                    
                    <p class="text-gray-300 mb-6">Answer **${quizData.length}** questions in 20 minutes! (Note: Expand to 30 questions in the code).</p>

                    <form id="quiz-form" class="space-y-6 scroll-y p-2">
                        ${quizData.map((q, index) => `
                            <div class="bg-gray-700 p-5 rounded-xl shadow-lg border-l-4 border-pink-400">
                                <p class="font-bold text-lg mb-3 text-white">Q${index + 1}: ${q.question}</p>
                                <div class="space-y-2">
                                    ${q.options.map((option, optIndex) => `
                                        <label class="flex items-center space-x-3 text-gray-300 hover:text-pink-300 transition cursor-pointer">
                                            <input type="radio" name="question_${index}" value="${option}" class="form-radio h-4 w-4 text-pink-500 border-gray-300">
                                            <span>${option}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                        
                        <button type="submit" class="w-full p-3 bg-pink-500 text-white font-bold rounded-lg shadow-lg hover:bg-pink-600 transition duration-150 transform hover:scale-[1.01]">
                            SUBMIT QUIZ
                        </button>
                    </form>
                    
                    <div id="quiz-result" class="mt-6 p-5 bg-indigo-700 rounded-xl hidden text-center font-bold text-xl"></div>
                    
                    ${getBackButton()}
                </div>
            `;
        }

        // Quiz Timer & Submission Logic
        function startQuizTimer() {
            const timerElement = document.getElementById('quiz-timer');
            if (!timerElement) return;

            // Clear any existing timer
            if (quizTimer) clearInterval(quizTimer);

            const updateTimer = () => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 300) { // Last 5 minutes
                    timerElement.classList.add('text-red-500');
                    timerElement.classList.remove('text-2xl');
                    timerElement.classList.add('text-3xl');
                } else {
                    timerElement.classList.remove('text-red-500');
                    timerElement.classList.add('text-2xl');
                }

                if (timeLeft <= 0) {
                    clearInterval(quizTimer);
                    submitQuiz(null, true); // Submit automatically on time up
                } else {
                    timeLeft--;
                }
            };
            
            updateTimer(); // Initial call
            quizTimer = setInterval(updateTimer, 1000);
        }

        function submitQuiz(event, timeUp = false) {
            if (quizTimer) clearInterval(quizTimer);
            
            const form = document.getElementById('quiz-form');
            const resultElement = document.getElementById('quiz-result');
            
            let correctAnswers = 0;
            
            quizData.forEach((q, index) => {
                const selector = `input[name="question_${index}"]:checked`;
                const selected = form.querySelector(selector);
                
                if (selected && selected.value === q.answer) {
                    correctAnswers++;
                }
            });

            const totalQuestions = quizData.length;
            const scorePercentage = (correctAnswers / totalQuestions) * 100;
            const timeMessage = timeUp ? `<span class="text-red-300">(Time Expired!)</span>` : '';
            
            resultElement.innerHTML = `
                ${timeMessage} Your Score: ${correctAnswers} / ${totalQuestions}<br>
                <span class="text-4xl font-black">${scorePercentage.toFixed(0)}%</span>
            `;
            resultElement.classList.remove('hidden');
            form.querySelectorAll('input').forEach(input => input.disabled = true);
            form.querySelector('button[type="submit"]').disabled = true;
        }


        function renderCommunity() {
            const profilePictures = [
                placeholderImageUrl(100, 100, 'ANIME+1', '4c7c8c', 'ffffff'),
                placeholderImageUrl(100, 100, 'ANIME+2', '6b4c8c', 'ffffff'),
                placeholderImageUrl(100, 100, 'ANIME+3', '8c4c4c', 'ffffff'),
                placeholderImageUrl(100, 100, 'ANIME+4', '4c8c5c', 'ffffff'),
            ];
            
            const posts = [
                { user: "Iron-Sensei", time: "2 hours ago", content: "Just hit a new PR on my squat! Consistency is key, friends. What's everyone training today?", img: profilePictures[0] },
                { user: "Cardio_Queen", time: "5 hours ago", content: "Finished a 10k run this morning. Fueling up with a veggie protein bowl now!", img: profilePictures[1] },
                { user: "GymRat_Goku", time: "1 day ago", content: "Any tips for bulking vegetarian style? I'm hitting a plateau. Protein shake recommendations?", img: profilePictures[2] },
            ];
            
            const postList = posts.map(p => `
                <div class="bg-gray-700 p-5 rounded-xl shadow-lg border-l-4 border-teal-400">
                    <div class="flex items-start mb-3">
                        <img src="${p.img}" alt="${p.user} profile" class="w-12 h-12 rounded-full object-cover mr-4 border-2 border-teal-400">
                        <div>
                            <p class="font-bold text-teal-300 text-lg">${p.user}</p>
                            <p class="text-sm text-gray-400">${p.time}</p>
                        </div>
                    </div>
                    <p class="text-gray-200 mt-2">${p.content}</p>
                </div>
            `).join('');

            return `
                <div class="max-w-xl mx-auto">
                    <h2 class="text-3xl font-extrabold text-indigo-400 mb-6">üí¨ Fitness Community Hub</h2>
                    <p class="text-gray-300 mb-6">Connect with fellow fitness enthusiasts (Anime PFP style!) and share your quest updates.</p>
                    
                    <div class="space-y-4 scroll-y">
                        <div class="bg-gray-800 p-4 rounded-xl shadow-inner">
                            <textarea placeholder="Share your fitness achievement or ask a question..." 
                                      class="w-full p-3 rounded-lg bg-gray-600 text-white border-none focus:ring-teal-400 focus:border-teal-400 resize-none" rows="3"></textarea>
                            <button class="mt-2 w-full p-3 bg-teal-500 text-white font-bold rounded-lg hover:bg-teal-600 transition">
                                Post to Community
                            </button>
                        </div>
                        ${postList}
                    </div>
                    
                    ${getBackButton()}
                </div>
            `;
        }
        
        function renderAbout() {
            // UPDATED: Added image path for all developers. Only shivang.jpg has been uploaded so far.
            const devList = [
                { name: "Aiman P", role: "Project Manager", img: "images/aiman.jpg" }, 
                { name: "Anugrah B Das", role: "Design Lead", img: "images/anu.jpg" }, 
                { name: "Shivang Sharma", role: "Leader and Coder", img: "images/shivang.jpg" }, 
                { name: "Binshad", role: "Backend/Data Specialist", img: "images/binshad.jpg" }
            ];

            return `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-extrabold text-indigo-400 mb-6">‚ÑπÔ∏è About FitQuest & Our Developers</h2>
                    
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl space-y-6">
                        <div class="text-lg text-gray-300">
                            **FitQuest** is dedicated to providing comprehensive, fun, and accessible fitness information. Our goal is to make your health journey engaging, from muscle anatomy to nutritional choices and challenge quizzes.
                        </div>
                        
                        <h3 class="text-2xl font-bold text-pink-400 border-b border-gray-700 pb-2">Meet the Quest Team</h3>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            ${devList.map(dev => {
                                // Logic to determine the image source, preferring the file path if provided
                                const imageSrc = dev.img 
                                    ? dev.img 
                                    : placeholderImageUrl(100, 100, dev.name.split(' ')[0], '6366f1', 'ffffff');
                                
                                // Fallback image URL in case the file path fails to load
                                const fallbackSrc = placeholderImageUrl(100, 100, dev.name.split(' ')[0], '6366f1', 'ffffff');
                                
                                return `
                                <div class="p-3 bg-gray-700 rounded-lg shadow-md hover:bg-gray-600 transition">
                                    <img src="${imageSrc}" 
                                         onerror="this.onerror=null;this.src='${fallbackSrc}'"
                                         alt="${dev.name} profile" 
                                         class="w-20 h-20 mx-auto rounded-full mb-3 object-cover border-2 border-indigo-500">
                                    <p class="font-semibold text-white">${dev.name.split(' ')[0]}</p>
                                    <p class="text-xs text-gray-400">${dev.role}</p>
                                </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="p-4 bg-yellow-900 bg-opacity-30 rounded-lg text-sm text-yellow-300 italic">
                            Thank you for joining our quest!
                        </div>
                    </div>
                    
                    ${getBackButton()}
                </div>
            `;
        }


        // --- 7. Gemini API Integration Functions ---
        
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // Utility function for making API calls with exponential backoff
        async function callGeminiAPI(payload, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < retries - 1) { // Rate limit handling
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    const candidate = result.candidates?.[0];
                    if (!candidate || !candidate.content?.parts?.[0]?.text) {
                        throw new Error('Invalid response structure from API.');
                    }
                    
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;

                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    return { text, sources };

                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    if (i === retries - 1) throw error;
                    // Exponential backoff logic is handled at the top of the loop
                }
            }
        }

        /**
         * Generates a recipe based on the user's query using Gemini with Google Search grounding.
         */
        async function generateRecipe() {
            if (isGeneratingRecipe || !recipeQuery.trim()) {
                console.log("Already generating or query is empty.");
                return;
            }

            isGeneratingRecipe = true;
            recipeResult = { text: '', sources: [] };
            renderApp(); // Show loading state

            const systemPrompt = `You are a world-class fitness and nutrition expert. Based on the user's query, find a healthy recipe and present it clearly. The recipe MUST include: Recipe Name, Ingredients (formatted as a list), and Instructions (formatted as a list). Do not include any conversational filler.`;
            
            const userQuery = `Generate a complete recipe for a fitness meal based on this request: "${recipeQuery}". Focus on health, protein content, and ease of preparation.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const result = await callGeminiAPI(payload);
                recipeResult = result;

            } catch (error) {
                console.error("Failed to generate recipe:", error);
                recipeResult = { 
                    text: "Sorry, I couldn't generate a recipe right now. Please check your query and try again later.", 
                    sources: [] 
                };
            } finally {
                isGeneratingRecipe = false;
                renderApp(); // Re-render with results/error
            }
        }

        // --- 8. Initialization ---
        window.navigateTo = navigateTo; // Expose to global scope for HTML inline handlers
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout; // Expose the new logout handler
        window.generateRecipe = generateRecipe; // Expose the new Gemini feature
        window.recipeQuery = recipeQuery; // Expose for input change handling
        
        window.addEventListener('load', renderApp);

    </script>

</body>
</html>

